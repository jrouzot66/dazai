services:
  # Base de donn√©es PostgreSQL
  database:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - symfony-network

  # Backend PHP 8.4
  api-php:
    build:
      context: ./api
      dockerfile: Dockerfile
    command: sh -c "composer install && php-fpm"
    volumes:
      - ./api:/var/www/api
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/app.ini:ro
    environment:
      DATABASE_URL: ${DATABASE_URL}
      MESSENGER_TRANSPORT_DSN: ${MESSENGER_TRANSPORT_DSN}
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
    networks:
      - symfony-network
    depends_on:
      - database
      - rabbitmq
      - elasticsearch

  # Serveur Web Nginx pour l'API
  api-nginx:
    image: nginx:1.27-alpine
    volumes:
      - ./api:/var/www/api
      - ./docker/nginx/api-vhost.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    networks:
      - symfony-network
    depends_on:
      - api-php

  # Frontend Vue 3
  front:
    build:
      context: ./front
    volumes:
      - ./front:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    networks:
      - symfony-network

  # RabbitMQ avec interface Management
  rabbitmq:
    image: rabbitmq:4-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "15672:15672" # Dashboard
    networks:
      - symfony-network

  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    networks:
      - symfony-network

networks:
  symfony-network:

volumes:
  db-data: